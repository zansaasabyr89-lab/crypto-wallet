<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>Blockchain Wallet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    /* стили оставлены без изменений */
  </style>
</head>
<body>
  <!-- NAVBAR и страницы оставлены как у тебя -->
  <!-- ... -->

<script>
/* === API URL === */
const API = "https://crypto-wallet-api.up.railway.app";

/* Утилиты */
const REWARD = 0.0003;
function fmtBTC(n) { return (Number(n).toFixed(8) + ' BTC'); }
function normalizePhoneFromMasked(masked) {
  let digits = String(masked || '').replace(/\D/g, '');
  if (digits.startsWith('7')) digits = '8' + digits.slice(1);
  if (!digits.startsWith('8')) digits = '8' + digits;
  return digits.slice(0,11);
}
function maskNameShort(user) {
  if (!user) return '—';
  const first = user.firstName?.trim() || '';
  const last = user.lastName?.trim() || '';
  return first ? `${first}.${last ? last[0].toUpperCase() : ''}` : '—';
}

/* Текущий пользователь хранится только в localStorage */
function getCurrentUserPhone() { return localStorage.getItem('bw_current_user') || null; }
function setCurrentUserPhone(phone) { phone ? localStorage.setItem('bw_current_user', phone) : localStorage.removeItem('bw_current_user'); }
function updateCurrentUserChip() {
  const chip = document.getElementById('currentUserChip');
  const phone = getCurrentUserPhone();
  if (!phone) { chip.textContent = 'Гость'; return; }
  chip.textContent = `${phone}`;
}

/* Навигация */
function openPage(page, evt) {
  document.querySelectorAll(".page").forEach(p => p.style.display = "none");
  document.getElementById(page).style.display = "block";
  document.querySelectorAll(".nav-links a").forEach(a => a.classList.remove("active"));
  if (evt && evt.target) evt.target.classList.add("active");
  if (page === 'wallet') refreshWallet();
  if (page === 'users') refreshUsers();
  if (page === 'history') refreshHistory();
  if (page === 'mining') refreshMiningUser();
  if (page === 'admin') refreshAdmin();
}

/* Регистрация */
async function register() {
  const firstName = document.getElementById('regFirstName').value.trim();
  const lastName = document.getElementById('regLastName').value.trim();
  const phoneMasked = document.getElementById('regPhone').value;
  const pin = document.getElementById('regPin').value.trim();
  const role = document.getElementById('regRole').value;
  const msg = document.getElementById('regMsg');

  try {
    const r = await fetch(API + "/api/register", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ firstName, lastName, phone: phoneMasked, pin, role })
    });
    const data = await r.json();
    if (!r.ok) { msg.innerHTML = '<span class="error">Ошибка регистрации</span>'; return; }
    setCurrentUserPhone(data.user.phone);
    updateCurrentUserChip();
    msg.innerHTML = '<span class="success">Регистрация успешна. Вы вошли.</span>';
    refreshWallet();
  } catch { msg.innerHTML = '<span class="error">Сервер недоступен</span>'; }
}

/* Вход */
async function login() {
  const phoneMasked = document.getElementById('loginPhone').value;
  const pin = document.getElementById('loginPin').value.trim();
  const msg = document.getElementById('loginMsg');

  try {
    const r = await fetch(API + "/api/login", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ phone: phoneMasked, pin })
    });
    const data = await r.json();
    if (!r.ok) { msg.innerHTML = '<span class="error">Вход не выполнен</span>'; return; }
    setCurrentUserPhone(data.user.phone);
    updateCurrentUserChip();
    msg.innerHTML = '<span class="success">Вход выполнен</span>';
    refreshWallet();
  } catch { msg.innerHTML = '<span class="error">Сервер недоступен</span>'; }
}
function logout() { setCurrentUserPhone(null); updateCurrentUserChip(); document.getElementById('loginMsg').innerHTML = '<span class="muted">Вы вышли</span>'; refreshWallet(); }

/* Кошелёк */
async function refreshWallet() {
  const phone = getCurrentUserPhone();
  const balEl = document.getElementById('balance');
  const addrEl = document.getElementById('walletAddress');
  const profEl = document.getElementById('profileInfo');

  if (!phone) { balEl.textContent = '—'; addrEl.value = '—'; profEl.textContent = 'Гость. Войдите, чтобы увидеть профиль.'; return; }

  try {
    const r = await fetch(API + "/api/user/" + phone);
    const data = await r.json();
    if (!r.ok) { balEl.textContent = '—'; addrEl.value = '—'; profEl.textContent = 'Ошибка'; return; }
    const u = data.user;
    balEl.textContent = fmtBTC(u.balance);
    addrEl.value = u.address;
    profEl.innerHTML = `Имя: ${u.firstName}<br>Фамилия: ${u.lastName}<br>Телефон: ${u.phone}<br>Адрес: ${u.address}<br>Роль: ${u.role}<br>Статус: ${u.blocked ? '<span class="error">Заблокирован</span>' : '<span class="success">Активен</span>'}`;
  } catch { balEl.textContent = '—'; addrEl.value = '—'; profEl.textContent = 'Сервер недоступен'; }
}
async function generateNewAddress() {
  const phone = getCurrentUserPhone(); if (!phone) { alert('Сначала войдите'); return; }
  await fetch(API + "/api/address", {
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ phone })
  });
  refreshWallet();
}
function generateQR(type) {
  const phone = getCurrentUserPhone(); if (!phone) { alert('Сначала войдите'); return; }
  const box = document.getElementById('qrcode'); box.innerHTML = '';
  new QRCode(box, { text: phone, width:160, height:160 });
}

/* Список пользователей */
async function refreshUsers() {
  const tbody = document.getElementById('usersTable'); tbody.innerHTML = '';
  const r = await fetch(API + "/api/users"); const data = await r.json();
  (data.users || []).forEach(u => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${u.phone}</td><td>${u.firstName}</td><td>${u.lastName}</td><td>${Number(u.balance).toFixed(8)}</td><td>${u.role}</td><td>${u.blocked ? 'Заблокирован' : 'Активен'}</td>`;
    tbody.appendChild(tr);
  });
}

/* Транзакции */
async function sendTransaction() {
  const fromPhone = getCurrentUserPhone();
  const msgEl = document.getElementById('txMessage');
  if (!fromPhone) { msgEl.innerHTML = '<span class="error">Сначала войдите</span>'; return; }

  const toPhoneMasked = document.getElementById('toPhone').value;
  const amount = parseFloat(document.getElementById('amount').value);
  const fee = parseFloat(document.getElementById('fee').value);
  const note = document.getElementById('note').value.trim();

  try {
    const r = await fetch(API + "/api/transaction", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ fromPhone, toPhone: toPhoneMasked, amount, fee, note })
    });
    const data = await r.json();
    if (!r.ok) { msgEl.innerHTML = '<span class="error">Ошибка транзакции</span>'; return; }
    msgEl.innerHTML = `<span class="success">Отправлено ${amount.toFixed(8)} BTC</span>`;
    refreshWallet(); refreshHistory();
  }
